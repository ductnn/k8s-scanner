name: Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build all platforms
        env:
          CGO_ENABLED: 0
        run: make build-all

      - name: Create release archive
        run: |
          cd bin
          tar -czf k8s-scanner-linux-amd64.tar.gz -C linux k8s-scanner
          tar -czf k8s-scanner-darwin-amd64.tar.gz -C darwin k8s-scanner
          zip -q k8s-scanner-windows-amd64.zip -j windows/k8s-scanner.exe

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: k8s-scanner-linux-amd64
          path: bin/k8s-scanner-linux-amd64.tar.gz
          retention-days: 90

      - name: Upload macOS binary
        uses: actions/upload-artifact@v4
        with:
          name: k8s-scanner-darwin-amd64
          path: bin/k8s-scanner-darwin-amd64.tar.gz
          retention-days: 90

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: k8s-scanner-windows-amd64
          path: bin/k8s-scanner-windows-amd64.zip
          retention-days: 90

      - name: Get version from git
        id: version
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev-$(git rev-parse --short HEAD)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Built version: $VERSION"

      - name: Create checksums
        run: |
          cd bin
          sha256sum k8s-scanner-linux-amd64.tar.gz > checksums.txt
          sha256sum k8s-scanner-darwin-amd64.tar.gz >> checksums.txt
          sha256sum k8s-scanner-windows-amd64.zip >> checksums.txt
          cat checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: bin/checksums.txt
          retention-days: 90

